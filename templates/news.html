{% extends "base.html" %}

{% block title %}Управление новостями - Админка бота новостей{% endblock %}
{% block page_title %}Управление новостями{% endblock %}

{% block content %}
<div class="row">
    <!-- Новости на модерации -->
    <div class="col-12 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-clock"></i> Новости на модерации 
                    <span class="badge bg-warning">{{ pending_news|length }}</span>
                </h5>
            </div>
            <div class="card-body">
                {% if pending_news %}
                    {% for news in pending_news %}
                    <div class="news-item p-4 mb-3 bg-light rounded">
                        <div class="row">
                            <div class="col-md-8">
                                <h5 class="mb-2">{{ news.title }}</h5>
                                <p class="text-muted mb-2">
                                    <i class="fas fa-tag"></i> <strong>Источник:</strong> {{ news.source }}
                                </p>
                                <p class="text-muted mb-2">
                                    <i class="fas fa-clock"></i> <strong>Добавлено:</strong> 
                                    {{ news.timestamp[:19] if news.timestamp else 'Неизвестно' }}
                                </p>
                                <p class="text-muted mb-3">
                                    <i class="fas fa-link"></i> <strong>Ссылка:</strong> 
                                    <a href="{{ news.link }}" target="_blank" class="text-decoration-none">
                                        {{ news.link[:80] }}{% if news.link|length > 80 %}...{% endif %}
                                    </a>
                                </p>
                                <a href="{{ news.link }}" target="_blank" class="btn btn-outline-primary btn-sm">
                                    <i class="fas fa-external-link-alt"></i> Открыть в новой вкладке
                                </a>
                            </div>
                            <div class="col-md-4 text-end">
                                <div class="d-grid gap-2">
                                    <button class="btn btn-approve text-white" onclick="approveNews({{ news.id }})">
                                        <i class="fas fa-check"></i> Одобрить и опубликовать
                                    </button>
                                    <button class="btn btn-reject text-white" onclick="rejectNews({{ news.id }})">
                                        <i class="fas fa-times"></i> Отклонить
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">Нет новостей на модерации</h5>
                        <p class="text-muted">Все новости обработаны или бот не нашел новых новостей</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Опубликованные новости -->
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-check-circle"></i> Опубликованные новости 
                    <span class="badge bg-success">{{ published_news|length }}</span>
                </h5>
            </div>
            <div class="card-body">
                {% if published_news %}
                    <div class="row">
                        {% for news in published_news[-20:] %}
                        <div class="col-md-6 mb-3">
                            <div class="news-item p-3 bg-light rounded">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="flex-grow-1">
                                        <h6 class="mb-1">{{ news.title }}</h6>
                                        <p class="text-muted mb-1">
                                            <i class="fas fa-tag"></i> {{ news.source }}
                                        </p>
                                        <p class="text-muted mb-2">
                                            <i class="fas fa-clock"></i> 
                                            {{ news.timestamp[:19] if news.timestamp else 'Неизвестно' }}
                                        </p>
                                        <a href="{{ news.link }}" target="_blank" class="btn btn-sm btn-outline-primary">
                                            <i class="fas fa-external-link-alt"></i> Открыть
                                        </a>
                                    </div>
                                    <div class="ms-2">
                                        <span class="badge bg-success">
                                            <i class="fas fa-check"></i> Опубликовано
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    
                    {% if published_news|length > 20 %}
                    <div class="text-center mt-3">
                        <p class="text-muted">Показаны последние 20 из {{ published_news|length }} опубликованных новостей</p>
                    </div>
                    {% endif %}
                {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-newspaper fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">Нет опубликованных новостей</h5>
                        <p class="text-muted">Одобренные новости будут отображаться здесь</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
function approveNews(newsId) {
    if (confirm('Вы уверены, что хотите одобрить эту новость?')) {
        fetch(`/api/approve/${newsId}`, {method: 'POST'})
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    showAlert('Новость одобрена и опубликована!', 'success');
                    setTimeout(() => location.reload(), 1000);
                } else {
                    showAlert('Ошибка: ' + data.message, 'danger');
                }
            })
            .catch(error => {
                showAlert('Ошибка сети: ' + error, 'danger');
            });
    }
}

function rejectNews(newsId) {
    if (confirm('Вы уверены, что хотите отклонить эту новость?')) {
        fetch(`/api/reject/${newsId}`, {method: 'POST'})
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    showAlert('Новость отклонена', 'warning');
                    setTimeout(() => location.reload(), 1000);
                } else {
                    showAlert('Ошибка: ' + data.message, 'danger');
                }
            })
            .catch(error => {
                showAlert('Ошибка сети: ' + error, 'danger');
            });
    }
}

// Автообновление каждые 30 секунд
setInterval(() => {
    fetch('/api/stats')
        .then(response => response.json())
        .then(data => {
            // Обновляем счетчики если нужно
            const pendingBadge = document.querySelector('.badge.bg-warning');
            const publishedBadge = document.querySelector('.badge.bg-success');
            
            if (pendingBadge) {
                pendingBadge.textContent = data.pending_count;
            }
            if (publishedBadge) {
                publishedBadge.textContent = data.published_count;
            }
        });
}, 30000);
</script>
{% endblock %}
